name: CI/CD Deploy

on:
  push:        # ğŸ”¥ ëª¨ë“  ë¸Œëœì¹˜ push ì‹œ ì‹¤í–‰ë¨
    branches:
      - '**'

jobs:
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Docker Hub ë¡œê·¸ì¸
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 2) Backend Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: Build Backend image
        run: |
          cd apps/backend
          docker build -t chat-app-backend .
          docker tag chat-app-backend ${{ secrets.DOCKERHUB_USERNAME }}/chat-app-backend:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/chat-app-backend:latest

      # 3) Frontend Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
      - name: Build Frontend image
        run: |
          cd apps/frontend
          docker build -t chat-app-frontend .
          docker tag chat-app-frontend ${{ secrets.DOCKERHUB_USERNAME }}/chat-app-frontend:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/chat-app-frontend:latest

  deploy:
    name: Deploy to EC2 (Parallel)
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest

    # ğŸ”¥ ë¨¼ì € EC2 ë¦¬ìŠ¤íŠ¸ë¥¼ envë¡œ ë³€í™˜
    env:
      EC2_LIST: ${{ secrets.EC2_DEPLOY_TARGETS }}

    strategy:
      fail-fast: false
      matrix:
        server: ${{ fromJson(env.EC2_LIST) }}

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ matrix.server }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu
            docker compose pull
            docker compose up -d --remove-orphans